---
title: "Fitting GP to lightcurve 428_...in Stan"
execute: 
  echo: false
format: 
  html:
    df-print: kable 
self-contained: true
---

Notebook outlining the fitting of GP to thunderKAT lightcurve ID$ 428_...

```{r}
#| message: false
library(conflicted)
library(ggplot2)
library(readr)
library(here)
library(cmdstanr)
library(posterior)
library(bayesplot)

color_scheme_set("brightblue")
register_knitr_engine(override = FALSE)
```

```{r}
csv_fname <- "428_ra236.530_dec-46.922_4U1543TraPDB_andersson.csv"
path_to_csv <- here("data_raw", csv_fname)
data_df <- read_csv(path_to_csv, show_col_types = FALSE)

x_star <- seq(from = min(data_df$mjd), to = max(data_df$mjd), length.out = 200)

data_df |> 
  ggplot() +
  aes(x = mjd, y = f_peak, ymax = f_peak + f_peak_err, ymin = f_peak - f_peak_err) +
  geom_point(colour = "blue") +
  geom_linerange() +
  labs(title = csv_fname, x = "MJD", y = "Flux Density (Jy)") +
  theme_classic()
```

```{r}
#| include: false
summary(data_df[c("f_peak", "f_peak_err", "mjd")])
```

- The light curve has $N =$ `r NROW(data_df)` observations over a range of `r diff(range(data_df$mjd))` days.
- The mean flux density is $\bar{y} =$ `r mean(data_df$f_peak)` Jy.
- The mean standard error is `r mean(data_df$f_peak)` Jy.
- The observational noise is faint relative to the brightness of the observations. 
- Observations are evenly spread over the time range.
- There are hints of correlated noise components in the light curve.

# Basic Model

- Zero constant mean function
- Homoskedastic noise
- Not using data on error in observations
- Wide prior on observational errors

$$y \sim \mathcal{N}(f(x), \sigma_\textrm{noise}^2)$$

$$f \sim \mathcal{GP}(\boldsymbol{0}, k(x,  x'))$$


$$k(x,x') = \eta^2 \exp\left\{ -\frac{1}{2}\frac{(x - x')^2}{\ell^2}\right\}$$

$$\ell \sim \mathrm{InvGamma}(5,5)$$

$$\eta \sim \mathcal{N}^+(0,1)$$

$$\sigma_\textrm{noise} \sim \mathcal{N}^+(0,1)$$

```{r}
basic_model <- cmdstan_model(stan_file = "stan/basic_model.stan")
```

```{r}
#| output: false
#| message: false
data_list <- list(N = length(data_df$mjd), 
                  x = data_df$mjd,
                  y = data_df$f_peak,
                  x_star = x_star,
                  N_star = length(x_star))

basic_fit <- basic_model$sample(
  data = data_list,
  seed = 1,
  chains = 4,
  parallel_chains = 4,
  refresh = 0
)
```

```{r}
#| include: false
basic_fit$cmdstan_diagnose()
```

## MCMC Results

```{r}
basic_fit$print(variables = c("eta", "ell", "sigma"), digits = 6)
```

```{r}
basic_draws_arr <- basic_fit$draws(format = "draws_array")
mcmc_trace(basic_draws_arr, pars = c("eta", "ell", "sigma"), facet_args = list(nrow = 2))
```

```{r}
mcmc_dens(basic_draws_arr, pars = c("eta", "ell", "sigma"), facet_args = list(nrow = 2))
```

```{r}
mcmc_pairs(basic_draws_arr, pars = c("eta", "ell", "sigma"), off_diag_fun = "hex")
```

## Posterior Predictive Samples

```{r}
basic_postpred_draws <- as_draws_rvars(basic_fit$draws("f_star"))

ggplot() +
  aes(x = x_star) +
  geom_ribbon(aes(ymin = quantile(basic_postpred_draws$f_star, probs = 0.16)[1,],
                  ymax = quantile(basic_postpred_draws$f_star, probs = 0.84)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_ribbon(aes(ymin = quantile(basic_postpred_draws$f_star, probs = 0.05)[1,],
                  ymax = quantile(basic_postpred_draws$f_star, probs = 0.95)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_line(aes(y = median(basic_postpred_draws$f_star)), linewidth = 1, colour = "black") +
  geom_linerange(aes(x = data_df$mjd, y = data_df$f_peak, 
                     ymax = data_df$f_peak + data_df$f_peak_err, 
                     ymin = data_df$f_peak - data_df$f_peak_err), colour = "red")  +
  geom_point(aes(x = data_df$mjd, y = data_df$f_peak), size = 2, colour = "red") +
  labs(x = "MJD", y = "Flux Density") +
  theme_classic()
```

The fitted model has a very long lengthscale, comparable to the length of the observational window. The estimated observational noise has a standard deviation more than an order of magnitude of that in the original data. The combination of these parameters has lead to a very smooth fit that passes through the middle of the observed data points rather than through any datapoints themselves.


# Observational Errors Model

- Zero constant mean function
- Include data on error in observations of $y_i$
- Heteroskedastic (Gaussian) noise

$$y_i \sim \mathcal{N}(f(x_i), \sigma_i^2)$$

$$f \sim \mathcal{GP}(\boldsymbol{0}, k(x,  x'))$$

$$k(x,x') = \eta^2 \exp\left\{ -\frac{1}{2}\frac{(x - x')^2}{\ell^2}\right\}$$

$$\ell \sim \mathrm{InvGamma}(5,5)$$

$$\eta \sim \mathcal{N}^+(0,1)$$

$$\sigma_i \sim \mathcal{N}^+(\textrm{stderr}(y_i), \mathrm{Var}(\textrm{stderr}(\boldsymbol{y})))$$

```{r}
err_model <- cmdstan_model("stan/err_model.stan")
```

```{r}
#| output: false
#| message: false
data_list <- list(N = length(data_df$mjd), 
                  x = data_df$mjd,
                  y = data_df$f_peak,
                  y_stderr = data_df$f_peak_err,
                  x_star = x_star,
                  N_star = length(x_star))

err_fit <- err_model$sample(
  data = data_list,
  seed = 1,
  chains = 4,
  parallel_chains = 4,
  refresh = 0
)
```

```{r}
#| include: false
err_fit$cmdstan_diagnose()
```

## MCMC Results

```{r}
err_fit$print(variables = c("eta", "ell", "sigma[1]"), digits = 6)
```

```{r}
err_draws_arr <- err_fit$draws(format = "draws_array")
mcmc_trace(err_draws_arr, pars = c("eta", "ell"), facet_args = list(nrow = 2))
```

```{r}
mcmc_dens(err_draws_arr, pars = c("eta", "ell"), facet_args = list(nrow = 2))
```

```{r}
mcmc_pairs(err_draws_arr, pars = c("eta", "ell"), off_diag_fun = "hex")
```

```{r fig.height=9}
mcmc_dens(err_draws_arr, regex_pars = "sigma", facet_args = list(nrow = 7))
```

## Posterior Predictive Samples

```{r}
err_postpred_draws <- as_draws_rvars(err_fit$draws("f_star"))

ggplot() +
  aes(x = x_star) +
  geom_ribbon(aes(ymin = quantile(err_postpred_draws$f_star, probs = 0.16)[1,],
                  ymax = quantile(err_postpred_draws$f_star, probs = 0.84)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_ribbon(aes(ymin = quantile(err_postpred_draws$f_star, probs = 0.05)[1,],
                  ymax = quantile(err_postpred_draws$f_star, probs = 0.95)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_line(aes(y = median(err_postpred_draws$f_star)), linewidth = 1, colour = "black") +
  geom_linerange(aes(x = data_df$mjd, y = data_df$f_peak, 
                     ymax = data_df$f_peak + data_df$f_peak_err, 
                     ymin = data_df$f_peak - data_df$f_peak_err), colour = "red")  +
  geom_point(aes(x = data_df$mjd, y = data_df$f_peak), size = 2, colour = "red") +
  labs(x = "MJD", y = "Flux Density") +
  theme_classic()
```

By including the observed observational errors for setting priors on the Gaussian noise of each observation, the fitted median passes through each of the observed points.

# Constant (non-zero) Mean function

- Constant mean function
- Prior on mean function value
- Include data on error in observations of $y_i$
- Heteroskedastic (Gaussian) noise

$$y_i \sim \mathcal{N}(f(x_i), \sigma_i^2)$$

$$f \sim \mathcal{GP}(C, k(x,  x'))$$

$$C \sim \mathcal{U}[0,1]$$

$$k(x,x') = \eta^2 \exp\left\{ -\frac{1}{2}\frac{(x - x')^2}{\ell^2}\right\}$$

$$\ell \sim \mathrm{InvGamma}(5,5)$$

$$\eta \sim \mathcal{N}^+(0,1)$$

$$\sigma_i \sim \mathcal{N}^+(\textrm{stderr}(y_i), \mathrm{Var}(\textrm{stderr}(\boldsymbol{y})))$$

```{r}
flat_mean_model <- cmdstan_model("stan/flat_mean_model.stan")
```

```{r}
#| message: false
#| output: false
data_list <- list(N = length(data_df$mjd), 
                  x = data_df$mjd,
                  y = data_df$f_peak,
                  y_stderr = data_df$f_peak_err,
                  x_star = x_star,
                  N_star = length(x_star))

flat_mean_fit <- flat_mean_model$sample(
  data = data_list,
  seed = 1,
  chains = 4,
  parallel_chains = 4,
  refresh = 0
)
```

```{r}
#| include: false
flat_mean_fit$cmdstan_diagnose()
```

## MCMC Results

```{r}
flat_mean_fit$print(variables = c("eta", "ell", "C", "sigma[1]"), digits = 6)
```

```{r}
flat_mean_draws_arr <- flat_mean_fit$draws(format = "draws_array")
mcmc_trace(flat_mean_draws_arr, pars = c("eta", "ell", "C"), facet_args = list(nrow = 2))
```

```{r}
mcmc_dens(flat_mean_draws_arr, pars = c("eta", "ell", "C"), facet_args = list(nrow = 2))
```

```{r}
mcmc_pairs(flat_mean_draws_arr, pars = c("eta", "ell", "C"), off_diag_fun = "hex")
```

## Posterior Predictive Samples

```{r}
flat_mean_postpred_draws <- as_draws_rvars(flat_mean_fit$draws("f_star"))

ggplot() +
  aes(x = x_star) +
  geom_ribbon(aes(ymin = quantile(flat_mean_postpred_draws$f_star, probs = 0.16)[1,],
                  ymax = quantile(flat_mean_postpred_draws$f_star, probs = 0.84)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_ribbon(aes(ymin = quantile(flat_mean_postpred_draws$f_star, probs = 0.05)[1,],
                  ymax = quantile(flat_mean_postpred_draws$f_star, probs = 0.95)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_line(aes(y = median(flat_mean_postpred_draws$f_star)), linewidth = 1, colour = "black") +
  geom_hline(aes(yintercept = mean(data_df$f_peak)), linetype = "dashed") +
  geom_hline(aes(yintercept = mean(flat_mean_fit$draws("C"))), colour = "orange") +
  geom_linerange(aes(x = data_df$mjd, y = data_df$f_peak, 
                     ymax = data_df$f_peak + data_df$f_peak_err, 
                     ymin = data_df$f_peak - data_df$f_peak_err), colour = "red")  +
  geom_point(aes(x = data_df$mjd, y = data_df$f_peak), size = 2, colour = "red") +
  labs(x = "MJD", y = "Flux Density") +
  theme_classic()
```



# Fixed constant (non-zero) Mean function

- Constant mean function set at fixed value, e.g., mean of observations
- Include data on error in observations of $y_i$
- Heteroskedastic (Gaussian) noise

$$y_i \sim \mathcal{N}(f(x_i), \sigma_i^2)$$

$$f \sim \mathcal{GP}(C, k(x,  x'))$$

$$k(x,x') = \eta^2 \exp\left\{ -\frac{1}{2}\frac{(x - x')^2}{\ell^2}\right\}$$

$$\ell \sim \mathrm{InvGamma}(5,5)$$

$$\eta \sim \mathcal{N}^+(0,1)$$

$$\sigma_i \sim \mathcal{N}^+(\textrm{stderr}(y_i), \mathrm{Var}(\textrm{stderr}(\boldsymbol{y})))$$

```{r}
fixed_mean_model <- cmdstan_model("stan/fixed_mean_model.stan")
```

## Mean Function = 0.2

```{r}
#| message: false
#| output: false
data_list <- list(N = length(data_df$mjd), 
                  x = data_df$mjd,
                  y = data_df$f_peak,
                  y_stderr = data_df$f_peak_err,
                  x_star = x_star,
                  N_star = length(x_star),
                  const_mean_value = 0.2)

fixed_mean_fit <- fixed_mean_model$sample(
  data = data_list,
  seed = 1,
  chains = 4,
  parallel_chains = 4,
  refresh = 0
)

fixed_mean_postpred_draws <- as_draws_rvars(fixed_mean_fit$draws("f_star"))
```

```{r}
ggplot() +
  aes(x = x_star) +
  geom_ribbon(aes(ymin = quantile(fixed_mean_postpred_draws$f_star, probs = 0.16)[1,],
                  ymax = quantile(fixed_mean_postpred_draws$f_star, probs = 0.84)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_ribbon(aes(ymin = quantile(fixed_mean_postpred_draws$f_star, probs = 0.05)[1,],
                  ymax = quantile(fixed_mean_postpred_draws$f_star, probs = 0.95)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_line(aes(y = median(fixed_mean_postpred_draws$f_star)), linewidth = 1, colour = "black") +
  geom_hline(aes(yintercept = mean(data_df$f_peak)), linetype = "dashed") +
  geom_hline(aes(yintercept = data_list$const_mean_value), colour = "orange") +
  geom_point(aes(x = data_df$mjd, y = data_df$f_peak), size = 2, colour = "red") +
  labs(x = "MJD", y = "Flux Density") +
  theme_classic()
```

## Mean Function = 0.195

```{r}
#| message: false
#| output: false
data_list <- list(N = length(data_df$mjd), 
                  x = data_df$mjd,
                  y = data_df$f_peak,
                  y_stderr = data_df$f_peak_err,
                  x_star = x_star,
                  N_star = length(x_star),
                  const_mean_value = 0.195)

fixed_mean_fit <- fixed_mean_model$sample(
  data = data_list,
  seed = 1,
  chains = 4,
  parallel_chains = 4,
  refresh = 0
)

fixed_mean_postpred_draws <- as_draws_rvars(fixed_mean_fit$draws("f_star"))
```

```{r}
ggplot() +
  aes(x = x_star) +
  geom_ribbon(aes(ymin = quantile(fixed_mean_postpred_draws$f_star, probs = 0.16)[1,],
                  ymax = quantile(fixed_mean_postpred_draws$f_star, probs = 0.84)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_ribbon(aes(ymin = quantile(fixed_mean_postpred_draws$f_star, probs = 0.05)[1,],
                  ymax = quantile(fixed_mean_postpred_draws$f_star, probs = 0.95)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_line(aes(y = median(fixed_mean_postpred_draws$f_star)), linewidth = 1, colour = "black") +
  geom_hline(aes(yintercept = mean(data_df$f_peak)), linetype = "dashed") +
  geom_hline(aes(yintercept = data_list$const_mean_value), colour = "orange") +
  geom_point(aes(x = data_df$mjd, y = data_df$f_peak), size = 2, colour = "red") +
  labs(x = "MJD", y = "Flux Density") +
  theme_classic()
```

## Mean Function = 0.18

```{r}
#| message: false
#| output: false
data_list <- list(N = length(data_df$mjd), 
                  x = data_df$mjd,
                  y = data_df$f_peak,
                  y_stderr = data_df$f_peak_err,
                  x_star = x_star,
                  N_star = length(x_star),
                  const_mean_value = 0.18)

fixed_mean_fit <- fixed_mean_model$sample(
  data = data_list,
  seed = 1,
  chains = 4,
  parallel_chains = 4,
  refresh = 0
)

fixed_mean_postpred_draws <- as_draws_rvars(fixed_mean_fit$draws("f_star"))
```

```{r}
ggplot() +
  aes(x = x_star) +
  geom_ribbon(aes(ymin = quantile(fixed_mean_postpred_draws$f_star, probs = 0.16)[1,],
                  ymax = quantile(fixed_mean_postpred_draws$f_star, probs = 0.84)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_ribbon(aes(ymin = quantile(fixed_mean_postpred_draws$f_star, probs = 0.05)[1,],
                  ymax = quantile(fixed_mean_postpred_draws$f_star, probs = 0.95)[1,]),
              fill = "blue", alpha = 0.3) +
  geom_line(aes(y = median(fixed_mean_postpred_draws$f_star)), linewidth = 1, colour = "black") +
  geom_hline(aes(yintercept = mean(data_df$f_peak)), linetype = "dashed") +
  geom_hline(aes(yintercept = data_list$const_mean_value), colour = "orange") +
  geom_point(aes(x = data_df$mjd, y = data_df$f_peak), size = 2, colour = "red") +
  labs(x = "MJD", y = "Flux Density") +
  theme_classic()
```

